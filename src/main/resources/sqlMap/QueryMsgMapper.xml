<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        <mapper namespace="bean.mybatisInterface.QueryMsg">
    <select id="getMsg" parameterType="bean.bean.MsgRelaBean" resultType="bean.bean.UserPublish">

         SELECT
                *
            FROM
            <![CDATA[
            (
            ]]>

                    SELECT
                        a.id as publishId,
                        a.context as postContext,
                        a.context_img as postImg,
                        a.gis_info as gisInfo,
                        a.status as status,
                        a.user_id as userId,
                        a.simple_img as simpleImg,
                        b.user_name as userName,
                        b.nick_name as nickName,
                        a.create_time as createTime,
                        b.head_img as headImg
                    FROM
                        UserPublish a,
                        User b
                    WHERE
                   ( a.inactive_time IS NULL
                    OR a.inactive_time > SYSDATE()  )
                    AND a.user_id = b.id
                    AND  a.publish_type = 0

                    <if test="watcherId!=null">
                        AND a.user_id = #{watcherId}
                    </if>
                    UNION
                        SELECT
                           a.id as publishId,
                           a.context as postContext,
                           a.context_img as postImg,
                           a.gis_info as gisInfo,
                           a.status as status,
                           a.user_id as userId,
                           a.simple_img as simpleImg,
                           b.user_name as userName,
                           b.nick_name as nickName,
                           a.create_time as createTime,
                           b.head_img as headImg
                        FROM
                            UserPublish a,
                            User b,
                            UserMsgQueue d
                        WHERE
                       (a.inactive_time > SYSDATE()
                        OR
                        a.inactive_time IS NULL  )
                        AND
                        a.id = d.publish_id
                        AND a.user_id = b.id
                        AND a.publish_type = 1
                        <if test="userId!=null">
                            AND d.user_id = #{userId}
                        </if>
                        <if test="watcherId!=null">
                            AND a.user_id = #{watcherId}
                        </if>
                <![CDATA[
                )
                ]]> c
        <where>
            <if test="publishId!=null">
                  publishId > #{publishId}
            </if>
        </where>

            ORDER BY
	c.createTime DESC
        limit 0,20
    </select>
</mapper>